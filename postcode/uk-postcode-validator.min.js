class UKPostcodeValidator{constructor(a={}){this.postcodes=a.postcodes||this.getDefaultPostcodes();let b='./uk-postcodes-full.json';try{const c=document.currentScript?.src||Array.from(document.scripts).find(d=>d.src.includes('uk-postcode-validator'))?.src;if(c){const d=c.substring(0,c.lastIndexOf('/')+1);b=d+'uk-postcodes-full.json'}}catch(e){console.warn('Could not auto-detect script path, using relative path')}this.options={dataUrl:a.dataUrl||b,minChars:a.minChars||2,debounceTime:a.debounceTime||300,errorMessage:a.errorMessage||'Sorry, we don\'t service this area yet. Please call +44 (0) 20 3773 0000 to discuss your requirements.',maxResults:a.maxResults||10,...a};this.debounceTimer=null;this.currentInput=null;this.dropdown=null;this.errorElement=null;this.init()}getDefaultPostcodes(){return["SW1A1AA","SW1A1AB","SW1A2AA","W1A0AX","W1A1AA","M11AA","M11AB","M60AA","B11AA","B11AB","LS11AA","LS11AB","E11AA","E11AB","E201AA","SE11AA","N11AA","NW11AA","EC1A1AA","WC1A1AA","BR11AA","BR11AB","CR01AA","TW11AA","KT11AA","SM11AA","IG11AA","RM11AA","DA11AA","UB11AA"]}async init(){if(this.options.dataUrl){await this.loadPostcodes()}this.setupFormIntegration()}async loadPostcodes(){try{const a=await fetch(this.options.dataUrl);if(!a.ok){throw new Error(`HTTP ${a.status}`)}const b=await a.json();if(Array.isArray(b)&&b.length>0){this.postcodes=b}}catch(c){console.warn('Failed to load postcodes from URL, using fallback data:',c)}}setupFormIntegration(){const a=document.querySelectorAll('input[name="business_postcode"], input[name*="postcode"], input[name*="postal"], input[id*="postcode"], input[id*="postal"]');if(a.length===0){console.warn('No postcode inputs found. Looking for common field patterns...');return}a.forEach(b=>{if(!b.dataset.ukPostcodeAttached){this.attachToInput(b);b.dataset.ukPostcodeAttached='true'}})}attachToInput(a){this.setupUI(a);a.addEventListener('input',b=>this.handleInput(b));a.addEventListener('keydown',b=>this.handleKeydown(b));a.addEventListener('blur',b=>this.handleBlur(b));a.addEventListener('focus',()=>this.hideError())}setupUI(a){const b=document.createElement('div');b.className='uk-postcode-container';b.style.position='relative';a.parentNode.insertBefore(b,a);b.appendChild(a);const c=document.createElement('div');c.className='uk-postcode-dropdown';c.style.cssText=`position: absolute;top: 100%;left: 0;right: 0;background: white;border: 1px solid #cbd6e2;border-top: none;border-radius: 0 0 3px 3px;max-height: 200px;overflow-y: auto;z-index: 1000;display: none;box-shadow: 0 2px 8px rgba(0,0,0,0.1);`;const d=document.createElement('div');d.className='uk-postcode-error';d.style.cssText=`color: #ff6600;font-size: 14px;margin-top: 4px;display: none;`;b.appendChild(c);b.appendChild(d);a.ukPostcodeDropdown=c;a.ukPostcodeError=d}handleInput(a){const b=a.target;const c=b.value.trim();clearTimeout(this.debounceTimer);if(c.length<this.options.minChars){this.hideDropdown(b);this.hideError(b);return}this.debounceTimer=setTimeout(()=>{const d=this.searchPostcodes(c);if(d.length>0){this.showDropdown(b,d);this.hideError(b)}else{this.hideDropdown(b);this.showError(b)}},this.options.debounceTime)}handleKeydown(a){const b=a.target;const c=b.ukPostcodeDropdown;if(!c||c.style.display==='none')return;const d=c.querySelectorAll('.uk-postcode-item');const e=c.querySelector('.uk-postcode-item.active');let f=e?Array.from(d).indexOf(e):-1;switch(a.key){case'ArrowDown':a.preventDefault();f=Math.min(f+1,d.length-1);this.setActiveItem(d,f);break;case'ArrowUp':a.preventDefault();f=Math.max(f-1,-1);this.setActiveItem(d,f);break;case'Enter':a.preventDefault();if(e){this.selectPostcode(b,e.textContent)}break;case'Escape':this.hideDropdown(b);break}}handleBlur(a){const b=a.target;setTimeout(()=>{this.validateCurrentInput(b);this.hideDropdown(b)},150)}setActiveItem(a,b){a.forEach((c,d)=>{if(d===b){c.classList.add('active');c.style.backgroundColor='#f5f8fa'}else{c.classList.remove('active');c.style.backgroundColor=''}})}searchPostcodes(a){const b=this.normalizePostcode(a);return this.postcodes.filter(c=>c.startsWith(b)).slice(0,this.options.maxResults)}normalizePostcode(a){return a.replace(/\s+/g,'').toUpperCase()}formatPostcode(a){const b=this.normalizePostcode(a);if(b.length>=5){return b.slice(0,-3)+' '+b.slice(-3)}return b}showDropdown(a,b){const c=a.ukPostcodeDropdown;c.innerHTML='';c.style.display='block';b.forEach(d=>{const e=document.createElement('div');e.className='uk-postcode-item';e.textContent=this.formatPostcode(d);e.style.cssText=`padding: 8px 12px;cursor: pointer;border-bottom: 1px solid #f5f8fa;`;e.addEventListener('mouseenter',()=>{this.setActiveItem([e],0)});e.addEventListener('mouseleave',()=>{e.classList.remove('active');e.style.backgroundColor=''});e.addEventListener('click',()=>{this.selectPostcode(a,e.textContent)});c.appendChild(e)})}hideDropdown(a){if(a&&a.ukPostcodeDropdown){a.ukPostcodeDropdown.style.display='none'}}selectPostcode(a,b){a.value=b;this.hideDropdown(a);this.hideError(a);a.dataset.ukPostcodeValid='true';const c=new Event('change',{bubbles:true});a.dispatchEvent(c)}validateCurrentInput(a){const b=a.value.trim();if(!b){this.hideError(a);return true}const c=this.normalizePostcode(b);const d=this.postcodes.includes(c);if(d){a.value=this.formatPostcode(b);a.dataset.ukPostcodeValid='true';this.hideError(a);return true}else{a.dataset.ukPostcodeValid='false';this.showError(a);return false}}validateForm(a){const b=a.querySelectorAll('input[data-uk-postcode-attached="true"]');let c=true;b.forEach(d=>{if(!this.validateCurrentInput(d)){c=false}});return c}showError(a){const b=a.ukPostcodeError;if(b){b.textContent=this.options.errorMessage;b.style.display='block'}}hideError(a){const b=a?a.ukPostcodeError:null;if(b){b.style.display='none'}}}if(typeof window!=='undefined'){window.UKPostcodeValidator=UKPostcodeValidator;document.addEventListener('DOMContentLoaded',()=>{if(window.ukPostcodeValidatorAutoInit!==false){new UKPostcodeValidator()}})}